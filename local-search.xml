<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>熔断器日志分析</title>
    <link href="/2023/10/09/breaker_es/"/>
    <url>/2023/10/09/breaker_es/</url>
    
    <content type="html"><![CDATA[<p>原因：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html</a></p><p>原因：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/fix-common-cluster-issues.html#high-jvm-memory-pressure">https://www.elastic.co/guide/en/elasticsearch/reference/current/fix-common-cluster-issues.html#high-jvm-memory-pressure</a><br>Elasticsearch 官方熔断器</p><p>父熔断器（Parent circuit breaker）</p><p>父熔断器限制所有子熔断器上使用的内存总量，当触发父熔断器熔断时，可能的日志信息如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Caused by: org<span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.breaker</span><span class="hljs-selector-class">.CircuitBreakingException</span>: <span class="hljs-selector-attr">[parent]</span> Data too large, data <span class="hljs-keyword">for</span> <span class="hljs-selector-attr">[&lt;transport_request&gt;]</span> would be <span class="hljs-selector-attr">[1749436147/1.6gb]</span>, which is larger than the limit of <span class="hljs-selector-attr">[1622605824/1.5gb]</span>, real usage: <span class="hljs-selector-attr">[1749435872/1.6gb]</span>, new bytes reserved: <span class="hljs-selector-attr">[275/275b]</span><br>Field data 熔断器（Field data breaker）<br></code></pre></td></tr></table></figure><p>当对 text 字段聚合或排序时，会产生 Field data 数据结构。Field data 熔断器会预估有多少数据被加载到内存中。当预估的数据占用内存到达 Field data 熔断器阈值时，会触发 Field data 熔断器熔断。此时可能的日志信息如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.breaker</span><span class="hljs-selector-class">.CircuitBreakingException</span>: <span class="hljs-selector-attr">[fielddata]</span> Data too large, data <span class="hljs-keyword">for</span> <span class="hljs-selector-attr">[_id]</span> would be <span class="hljs-selector-attr">[943928680/900.2mb]</span>, which is larger than the limit of <span class="hljs-selector-attr">[255606128/243.7mb]</span><br></code></pre></td></tr></table></figure><p>In flight 请求熔断器（In flight requests circuit breaker）</p><p>In flight 请求熔断器限制了在 transport 和 HTTP 层的所有当前传入的请求所使用的内存。当触发 In flight 请求熔断器时，可能的日志信息如下：</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs inform7"><span class="hljs-comment">[o.e.x.m.e.l.LocalExporter]</span> <span class="hljs-comment">[1611816935001404932]</span> unexpected error while indexing monitoring document<br>org.elasticsearch.xpack.monitoring.exporter.ExportException: RemoteTransportException<span class="hljs-comment">[<span class="hljs-comment">[1611816935001404732]</span><span class="hljs-comment">[9.10.153.16:9300]</span><span class="hljs-comment">[indices:data/write/bulk<span class="hljs-comment">[s]</span>]</span>]</span>; nested: CircuitBreakingException<span class="hljs-comment">[<span class="hljs-comment">[in_flight_requests]</span> Data too large, data for <span class="hljs-comment">[&lt;transport_request&gt;]</span> would be <span class="hljs-comment">[19491363612/18.1gb]</span>, which is larger than the limit of <span class="hljs-comment">[17066491904/15.8gb]</span>]</span>;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Caused by: org.elasticsearch.common.breaker.CircuitBreakingException: [parent] Data too large,<br> data <span class="hljs-keyword">for</span> [&lt;transport_request&gt;] would be [16333370524/15.2gb], <span class="hljs-comment"># A</span><br> <span class="hljs-built_in">which</span> is larger than the <span class="hljs-built_in">limit</span> of [16287753830/15.1gb], <span class="hljs-comment"># B</span><br> real usage: [16333368168/15.2gb], <span class="hljs-comment"># C</span><br> new bytes reserved: [2356/2.3kb], <span class="hljs-comment"># D</span><br> usages [request=0/0b, fielddata=0/0b, in_flight_requests=4476/4.3kb, accounting=7570257/7.2mb]<br></code></pre></td></tr></table></figure><p>这里有4个数值。</p><p>B处 的数值就是上限，超过这个就报错。（缺省是它是ES最大内存的95%），</p><p>C处 的数值是你的本机上ES进程已使用的内存大小，</p><p>D处 的数值2356就是你本次操作（或者说执行当前的任务）所需要内存，</p><p>C + D &#x3D; A &gt; B，所以报错了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[INFO ][o.e.m.j.JvmGcMonitorService] [node_1] [gc][number] overhead, spent [21s] collecting <span class="hljs-keyword">in</span> the last [40s]<br></code></pre></td></tr></table></figure><p>随着内存使用量的增加，垃圾收集变得更加频繁并且需要更长的时间。您可以在 elasticsearch.log.例如，以上事件表明 node_1 在过去 40秒中花费了超过 50%（21 秒）执行垃圾收集</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Ubuntu 18.04 部署 Elasticsearch 7.x 集群</title>
    <link href="/2023/10/08/install_es/"/>
    <url>/2023/10/08/install_es/</url>
    
    <content type="html"><![CDATA[<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>es-node-001: 192.168.0.1</li><li>es-node-002: 192.168.0.2</li><li>es-node-003: 192.168.0.3</li></ul><h2 id="配置-hostname-及-hosts"><a href="#配置-hostname-及-hosts" class="headerlink" title="配置 hostname 及 hosts"></a>配置 hostname 及 hosts</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">// 192.168.0.1<br><span class="hljs-comment"># sudo hostnamectl set-hostname es-node-001</span><br><span class="hljs-comment"># sudo vim /etc/hosts</span><br>192.168.0.1es-node-001<br>192.168.0.2es-node-002<br>192.168.0.3es-node-003<br><br>// 192.168.0.2<br><span class="hljs-comment"># sudo hostnamectl set-hostname es-node-002</span><br><span class="hljs-comment"># sudo vim /etc/hosts</span><br>192.168.0.1es-node-001<br>192.168.0.2es-node-002<br>192.168.0.3es-node-003<br><br>// 192.168.0.3<br><span class="hljs-comment"># sudo hostnamectl set-hostname es-node-002</span><br><span class="hljs-comment"># sudo vim /etc/hosts</span><br>192.168.0.1es-node-001<br>192.168.0.2es-node-002<br>192.168.0.3es-node-003<br></code></pre></td></tr></table></figure><h2 id="导入-Elasticsearch-PGP-Key"><a href="#导入-Elasticsearch-PGP-Key" class="headerlink" title="导入 Elasticsearch PGP Key"></a>导入 Elasticsearch PGP Key</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sudo wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -</span><br></code></pre></td></tr></table></figure><h2 id="添加-Elasticsearch-Repo"><a href="#添加-Elasticsearch-Repo" class="headerlink" title="添加 Elasticsearch Repo"></a>添加 Elasticsearch Repo</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sudo apt-get install apt-transport-https</span><br><span class="hljs-comment"># echo &quot;deb https://artifacts.elastic.co/packages/7.x/apt stable main&quot; | sudo tee -a /etc/apt/sources.list.d/elastic-7.x.list</span><br></code></pre></td></tr></table></figure><h2 id="安装-Elasticsearch"><a href="#安装-Elasticsearch" class="headerlink" title="安装 Elasticsearch"></a>安装 Elasticsearch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sudo apt-get update &amp;&amp; sudo apt-get install elasticsearch</span><br></code></pre></td></tr></table></figure><h2 id="配置-elasticsearch-yml"><a href="#配置-elasticsearch-yml" class="headerlink" title="配置 elasticsearch.yml"></a>配置 elasticsearch.yml</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs bash">// 192.168.0.1<br><span class="hljs-comment"># sudo vim /etc/elasticsearch/elasticsearch.yml</span><br>cluster.name: es-cluster<br>node.name: es-node-001<br>path.data: /opt/elasticsearch<br>path.logs: /var/log/elasticsearch<br>bootstrap.memory_lock: <span class="hljs-literal">true</span><br>network.host: 192.168.0.1<br>http.port: 9200<br>discovery.seed_hosts: [<span class="hljs-string">&quot;192.168.0.1&quot;</span>, <span class="hljs-string">&quot;192.168.0.2&quot;</span>, <span class="hljs-string">&quot;192.168.0.3&quot;</span>]<br>cluster.initial_master_nodes: [<span class="hljs-string">&quot;es-node-001&quot;</span>, <span class="hljs-string">&quot;es-node-002&quot;</span>, <span class="hljs-string">&quot;es-node-003&quot;</span>]<br>gateway.recover_after_nodes: 3<br>action.destructive_requires_name: <span class="hljs-literal">true</span><br>http.cors.enabled : <span class="hljs-literal">true</span><br>http.cors.allow-origin: <span class="hljs-string">&quot;*&quot;</span><br>http.cors.allow-methods: OPTIONS, HEAD, GET, POST, PUT, DELETE<br>http.cors.allow-headers: X-Requested-With,X-Auth-Token,Content-Type,Content-Length<br>http.cors.allow-credentials: <span class="hljs-literal">true</span><br><br>// 192.168.0.2<br><span class="hljs-comment"># sudo vim /etc/elasticsearch/elasticsearch.yml</span><br>cluster.name: es-cluster<br>node.name: es-node-002<br>path.data: /opt/elasticsearch<br>path.logs: /var/log/elasticsearch<br>bootstrap.memory_lock: <span class="hljs-literal">true</span><br>network.host: 192.168.0.2<br>http.port: 9200<br>discovery.seed_hosts: [<span class="hljs-string">&quot;192.168.0.1&quot;</span>, <span class="hljs-string">&quot;192.168.0.2&quot;</span>, <span class="hljs-string">&quot;192.168.0.3&quot;</span>]<br>cluster.initial_master_nodes: [<span class="hljs-string">&quot;es-node-001&quot;</span>, <span class="hljs-string">&quot;es-node-002&quot;</span>, <span class="hljs-string">&quot;es-node-003&quot;</span>]<br>gateway.recover_after_nodes: 3<br>action.destructive_requires_name: <span class="hljs-literal">true</span><br>http.cors.enabled : <span class="hljs-literal">true</span><br>http.cors.allow-origin: <span class="hljs-string">&quot;*&quot;</span><br>http.cors.allow-methods: OPTIONS, HEAD, GET, POST, PUT, DELETE<br>http.cors.allow-headers: X-Requested-With,X-Auth-Token,Content-Type,Content-Length<br>http.cors.allow-credentials: <span class="hljs-literal">true</span><br><br>// 192.168.0.3<br><span class="hljs-comment"># sudo vim /etc/elasticsearch/elasticsearch.yml</span><br>cluster.name: es-cluster<br>node.name: es-node-003<br>path.data: /opt/elasticsearch<br>path.logs: /var/log/elasticsearch<br>bootstrap.memory_lock: <span class="hljs-literal">true</span><br>network.host: 192.168.0.3<br>http.port: 9200<br>discovery.seed_hosts: [<span class="hljs-string">&quot;192.168.0.1&quot;</span>, <span class="hljs-string">&quot;192.168.0.2&quot;</span>, <span class="hljs-string">&quot;192.168.0.3&quot;</span>]<br>cluster.initial_master_nodes: [<span class="hljs-string">&quot;es-node-001&quot;</span>, <span class="hljs-string">&quot;es-node-002&quot;</span>, <span class="hljs-string">&quot;es-node-003&quot;</span>]<br>gateway.recover_after_nodes: 3<br>action.destructive_requires_name: <span class="hljs-literal">true</span><br>http.cors.enabled : <span class="hljs-literal">true</span><br>http.cors.allow-origin: <span class="hljs-string">&quot;*&quot;</span><br>http.cors.allow-methods: OPTIONS, HEAD, GET, POST, PUT, DELETE<br>http.cors.allow-headers: X-Requested-With,X-Auth-Token,Content-Type,Content-Length<br>http.cors.allow-credentials: <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="配置-jvm-options"><a href="#配置-jvm-options" class="headerlink" title="配置 jvm.options"></a>配置 jvm.options</h2><p>Elasticsearch 默认设置 1GB heap size，参数视机器内存大小而定，一般为机器内存的一半，但不要超过32GB</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sudo vim /etc/elasticsearch/jvm.options</span><br>...<br><span class="hljs-comment">################################################################</span><br><br><span class="hljs-comment"># Xms represents the initial size of total heap space</span><br><span class="hljs-comment"># Xmx represents the maximum size of total heap space</span><br><br>-Xms1g<br>-Xmx1g<br>...<br></code></pre></td></tr></table></figure><h2 id="修改-elasticsearch-service"><a href="#修改-elasticsearch-service" class="headerlink" title="修改 elasticsearch.service"></a>修改 elasticsearch.service</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sudo vim /usr/lib/systemd/system/elasticsearch.service</span><br>...<br><span class="hljs-comment"># Specifies the maximum file descriptor number that can be opened by this process</span><br>LimitNOFILE=65535<br><br><span class="hljs-comment"># Specifies the maximum number of processes</span><br>LimitNPROC=4096<br><br>...<br><span class="hljs-comment"># Disable swapping memory# 添加这2行</span><br>LimitMEMLOCK=infinity<br>...<br><span class="hljs-comment"># sudo systemctl daemon-reload</span><br></code></pre></td></tr></table></figure><h2 id="配置系统参数"><a href="#配置系统参数" class="headerlink" title="配置系统参数"></a>配置系统参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sudo vim /etc/sysctl.d/99-optimize.conf</span><br><span class="hljs-comment"># Virtual Memory</span><br>vm.swappiness = 0<br>vm.max_map_count = 262144<br>vm.overcommit_memory = 1<br><br><span class="hljs-comment"># 使内核配置生效</span><br>$ sudo sysctl -p /etc/sysctl.d/99-optimize.conf<br><br><span class="hljs-comment"># sudo vim /etc/security/limits.d/optimize.conf</span><br>*               soft    <span class="hljs-built_in">nproc</span>           65535<br>*               hard    <span class="hljs-built_in">nproc</span>           65535<br>*               soft    nofile          65535<br>*               hard    nofile          65535<br>*               soft    memlock         unlimited<br>*               hard    memlock         unlimited<br>$ <span class="hljs-built_in">exit</span><br><span class="hljs-comment"># 退出终端，再次登录终端，使ulimit生效</span><br><br>$ sudo <span class="hljs-built_in">mkdir</span> /opt/elasticsearch<br>$ sudo <span class="hljs-built_in">chmod</span> 777 /opt/elasticsearch<br></code></pre></td></tr></table></figure><h2 id="配置开机启动并启动-Elasticsearch"><a href="#配置开机启动并启动-Elasticsearch" class="headerlink" title="配置开机启动并启动 Elasticsearch"></a>配置开机启动并启动 Elasticsearch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sudo systemctl enable elasticsearch &amp;&amp; sudo systemctl start elasticsearch</span><br><span class="hljs-comment"># sudo systemctl status elasticsearch</span><br></code></pre></td></tr></table></figure><h2 id="检查-Elasticsearch-集群状态"><a href="#检查-Elasticsearch-集群状态" class="headerlink" title="检查 Elasticsearch 集群状态"></a>检查 Elasticsearch 集群状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl -XGET &quot;http://192.168.0.1:9200/_cluster/health?pretty&quot;</span><br>&#123;<br>  <span class="hljs-string">&quot;cluster_name&quot;</span> : <span class="hljs-string">&quot;es-cluster&quot;</span>,<br>  <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;green&quot;</span>,<br>  <span class="hljs-string">&quot;timed_out&quot;</span> : <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;number_of_nodes&quot;</span> : 3,<br>  <span class="hljs-string">&quot;number_of_data_nodes&quot;</span> : 3,<br>  <span class="hljs-string">&quot;active_primary_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;active_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;relocating_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;initializing_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;unassigned_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;delayed_unassigned_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;number_of_pending_tasks&quot;</span> : 0,<br>  <span class="hljs-string">&quot;number_of_in_flight_fetch&quot;</span> : 0,<br>  <span class="hljs-string">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,<br>  <span class="hljs-string">&quot;active_shards_percent_as_number&quot;</span> : 100.0<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="查看-Elasticsearch-节点信息"><a href="#查看-Elasticsearch-节点信息" class="headerlink" title="查看 Elasticsearch 节点信息"></a>查看 Elasticsearch 节点信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl -X GET &quot;http://192.168.0.1:9200/_cat/nodes?v&quot;</span><br>192.168.0.2  9 78 0 0.05 0.01 0.00 dilm - es-node-002<br>192.168.0.1  8 79 0 0.00 0.01 0.00 dilm - es-node-001<br>192.168.0.3 10 87 0 0.05 0.04 0.00 dilm * es-node-003<br></code></pre></td></tr></table></figure><blockquote><p><code>*</code> 表示 Elasticsearch Master</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>keepalived保证nginx高可用</title>
    <link href="/2023/09/27/keepalived+nginx/"/>
    <url>/2023/09/27/keepalived+nginx/</url>
    
    <content type="html"><![CDATA[<h2 id="MASTER配置"><a href="#MASTER配置" class="headerlink" title="MASTER配置"></a>MASTER配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">global_defs &#123;<br>    router_id LVS_1<br>    script_user root<br>    enable_script_security<br>&#125;<br>vrrp_script chk_nginx &#123;<br>    script <span class="hljs-string">&quot;/usr/bin/killall -0 nginx&quot;</span><br>    interval 2<br>    weight -30<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    interface ens18<br>    virtual_router_id 1<br>    priority 100<br>    advert_int 1<br><br>    virtual_ipaddress&#123;<br>        172.16.68.3/24 dev ens18<br>    &#125;<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br><br>    track_script &#123;<br>        chk_nginx<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>vrrp_instance段中参数说明：</p><ul><li>vrrp_instance VI_1：设置keepalive虚拟路由器VRRP的名称</li><li>state MASTER：设置为MASTER，将其他keepalive均设置为BACKUP</li><li>interface ens33：设置VIP地址的网卡名称为ens33</li><li>virtual_route_id 51：设置keepalive的id，全局唯一</li><li>priority 100：设置优先级为100</li><li>virtual_ipaddress：设置VIP地址</li><li>authentication：访问keepalive服务的鉴权信息</li><li>track_script：HAProxy健康检查脚本</li></ul><h2 id="主备配置差异"><a href="#主备配置差异" class="headerlink" title="主备配置差异"></a>主备配置差异</h2><ul><li>router_id</li><li>state BACKUP，这是因为在整个keepalive集群中只能存在一个MASTER，如果keepalived集群不止2实例，那么其他都应该被设置为BACKUP</li></ul><h2 id="BACKUP配置"><a href="#BACKUP配置" class="headerlink" title="BACKUP配置"></a>BACKUP配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">global_defs</span> &#123;<br>    <span class="hljs-string">router_id</span> <span class="hljs-string">LVS_2</span><br>    <span class="hljs-string">script_user</span> <span class="hljs-string">root</span><br>    <span class="hljs-string">enable_script_security</span> <br>&#125;<br><span class="hljs-string">vrrp_script</span> <span class="hljs-string">chk_nginx</span> &#123;<br>    <span class="hljs-string">script</span> <span class="hljs-string">&quot;/usr/bin/killall -0 nginx&quot;</span><br>    <span class="hljs-string">interval</span> <span class="hljs-number">2</span><br>    <span class="hljs-string">weight</span> <span class="hljs-number">-30</span><br>&#125;<br><br><span class="hljs-string">vrrp_instance</span> <span class="hljs-string">VI_1</span> &#123;<br>    <span class="hljs-string">state</span> <span class="hljs-string">BACKUP</span><br>    <span class="hljs-string">interface</span> <span class="hljs-string">ens18</span><br>    <span class="hljs-string">virtual_router_id</span> <span class="hljs-number">1</span><br>    <span class="hljs-string">priority</span> <span class="hljs-number">100</span><br>    <span class="hljs-string">advert_int</span> <span class="hljs-number">1</span><br>    <br>    <span class="hljs-string">virtual_ipaddress</span>&#123;<br>        <span class="hljs-number">172.16</span><span class="hljs-number">.68</span><span class="hljs-number">.3</span><span class="hljs-string">/24</span> <span class="hljs-string">dev</span> <span class="hljs-string">ens18</span>     <br>    &#125;<br>    <span class="hljs-string">authentication</span> &#123;<br>        <span class="hljs-string">auth_type</span> <span class="hljs-string">PASS</span><br>        <span class="hljs-string">auth_pass</span> <span class="hljs-number">123456</span><br>    &#125;<br>    <br>    <span class="hljs-string">track_script</span> &#123;<br>        <span class="hljs-string">chk_nginx</span><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>keepalived</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>keepalived</tag>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
